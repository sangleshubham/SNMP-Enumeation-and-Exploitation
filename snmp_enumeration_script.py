#!/usr/bin/env python3
import sys
import re
import subprocess

community_file = "./community"
ip_list = {}
enum_dict = {"System Processes": "1.3.6.1.2.1.25.1.6.0", "Running Programs": "1.3.6.1.2.1.25.4.2.1.2", "Processes Path": "1.3.6.1.2.1.25.4.2.1.4",
             "Storage Units": "1.3.6.1.2.1.25.2.3.1.4", "Software Name": "1.3.6.1.2.1.25.6.3.1.2", "User Accounts": "1.3.6.1.4.1.77.1.2.25", "TCP Local Ports": "1.3.6.1.2.1.6.13.1.3"}


jsondata = {}

def gathering_info(com, ip):
    print("    IP: ", ip, "\n    Community: ", com, "\n")
    for comment in enum_dict:
        out = subprocess.Popen(['snmpwalk', '-c', com, '-v1', ip, enum_dict[comment]],
                               stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, err = out.communicate()
        stdout = stdout.decode("utf-8")
        if stdout.strip() != "":
            print("\n")
            print("\t ", comment, ":", "\n")
            for line in re.findall("iso.*\n", stdout):
                print("\t\t ", line, end="")
def looping(ips):
    for com in ips:
        gathering_info(com, ips[com][0])

if len(sys.argv) > 1:
    ip_file = sys.argv[1]
    p = subprocess.Popen(['onesixtyone', '-c', community_file, '-i',
                          ip_file, "-o", "remove_me"], stdout=subprocess.PIPE)
    output = p.communicate()
    rc = p.returncode
    # print(output[0].decode('utf-8'))
    rc = 0
    if rc == 0:
        with open("remove_me", "r") as file:
            if file.__sizeof__() > 0:
                for line in file:
                    # print(line)
                    if len(re.findall("[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+", line)) > 0:
                        ip = str(re.findall(
                            "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+", line)[0].strip())
                        if len(re.findall("\[(\w+)\]", line)) > 0:
                            com = str(re.findall("\[(\w+)\]", line)[0].strip())
                            # print(ip ,com)
                            if com in ip_list:
                                ip_list[com] = ip_list[com]
                            else:
                                ip_list[com] = [ip]
                temp = []
                if len(ip_list) < 1:
                    print("\tNon of the server is vulnerable to SNMP Enumeration")
                    exit()
                print("Found IP's:")
                for val in ip_list:
                    print("\t ", val.ljust(20), ip_list[val][0].ljust(50))
                print("\nStarting Enumeration:")
                looping(ip_list)
            else:
                print("IP have no SNMP Records")
else:
    print("Wrong Syntax \n      ", sys.argv[0].split("/")[-1], "[IP]")